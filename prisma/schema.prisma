// 1. 生成器配置
generator client {
  provider = "prisma-client-js"
}

// 2. 数据源配置
datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum OrderStatus {
  CREATED
  AGREED
  STAKED
  LOCKED
  DELIVERED
  COMPLETED
  CANCELLED
  DISPUTED
  REFUNDED
}

model User {
  id            String    @id @default(cuid())
  walletAddress String    @unique
  nonce         String?
  nickname      String?
  avatar        String?
  rating        Float     @default(5.0)
  createdAt     DateTime  @default(now())
  
  ordersAsBuyer  Order[]  @relation("BuyerOrders")
  ordersAsSeller Order[]  @relation("SellerOrders")
  messages       Message[]
  evidences      Evidence[]

  @@map("users")
}

model Order {
  id            String      @id @default(cuid())
  shortId       String      @unique
  title         String
  description   String      @db.Text
  amount        String
  tokenSymbol   String      @default("USDT")
  daysToDeliver Int
  status        OrderStatus @default(CREATED)
  
  // 新增：记录链上状态的数字 (0-8)，用于列表页直接显示
  chainState    Int         @default(0) 
  
  // 新增：记录最后一次改变状态的人的钱包地址，用于红点提示
  lastActionBy  String?

  contractId    String?
  txHash        String?
  
  buyerId       String
  buyer         User        @relation("BuyerOrders", fields: [buyerId], references: [id])
  sellerId      String?
  seller        User?       @relation("SellerOrders", fields: [sellerId], references: [id])

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  messages      Message[]
  evidences     Evidence[]

  @@map("orders")
}

model Message {
  id        String   @id @default(cuid())
  content   String   @db.Text
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id])
  senderId  String
  sender    User     @relation(fields: [senderId], references: [id])
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@map("messages")
}

model Evidence {
  id          String   @id @default(cuid())
  fileUrl     String
  fileType    String
  description String?
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id])
  uploaderId  String
  uploader    User     @relation(fields: [uploaderId], references: [id])
  createdAt   DateTime @default(now())

  @@map("evidences")
}
